// pages/index/index.js
// 互动点子库 - 主页面逻辑

// 激励视频广告位 id：请在微信公众平台「流量主」-「广告管理」中申请激励式视频广告位后，替换为你的 adUnitId
const REWARDED_VIDEO_AD_UNIT_ID = 'adunit-xxxxxxxx'

// 广告开关：true 表示需要看广告，false 表示跳过广告（可通过代码直接控制）
const AD_ENABLED = false

// 24点算术预设组合（600个已验证能计算出24的数字组合）
const GAME24_COMBINATIONS = [
  [1,1,1,8],   [1,1,1,11],   [1,1,1,12],   [1,1,1,13],   [1,1,2,6],   [1,1,2,7],   [1,1,2,8],   [1,1,2,9],
  [1,1,2,10],   [1,1,2,11],   [1,1,2,12],   [1,1,2,13],   [1,1,3,4],   [1,1,3,5],   [1,1,3,6],   [1,1,3,7],
  [1,1,3,8],   [1,1,3,9],   [1,1,3,10],   [1,1,3,11],   [1,1,3,12],   [1,1,3,13],   [1,1,4,4],   [1,1,4,5],
  [1,1,4,6],   [1,1,4,7],   [1,1,4,8],   [1,1,4,9],   [1,1,4,10],   [1,1,4,12],   [1,1,5,5],   [1,1,5,6],
  [1,1,5,7],   [1,1,5,8],   [1,1,6,6],   [1,1,6,8],   [1,1,6,9],   [1,1,6,12],   [1,1,7,10],   [1,1,8,8],
  [1,1,9,13],   [1,1,10,12],   [1,1,10,13],   [1,1,11,11],   [1,1,11,12],   [1,1,11,13],   [1,1,12,12],   [1,1,12,13],
  [1,1,13,13],   [1,2,2,4],   [1,2,2,5],   [1,2,2,6],   [1,2,2,7],   [1,2,2,8],   [1,2,2,9],   [1,2,2,10],
  [1,2,2,11],   [1,2,2,12],   [1,2,2,13],   [1,2,3,3],   [1,2,3,4],   [1,2,3,5],   [1,2,3,6],   [1,2,3,7],
  [1,2,3,8],   [1,2,3,9],   [1,2,3,10],   [1,2,3,11],   [1,2,3,12],   [1,2,3,13],   [1,2,4,4],   [1,2,4,5],
  [1,2,4,6],   [1,2,4,7],   [1,2,4,8],   [1,2,4,9],   [1,2,4,10],   [1,2,4,11],   [1,2,4,12],   [1,2,4,13],
  [1,2,5,5],   [1,2,5,6],   [1,2,5,7],   [1,2,5,8],   [1,2,5,9],   [1,2,5,10],   [1,2,5,12],   [1,2,5,13],
  [1,2,6,6],   [1,2,6,7],   [1,2,6,8],   [1,2,6,9],   [1,2,6,10],   [1,2,6,11],   [1,2,6,12],   [1,2,6,13],
  [1,2,7,7],   [1,2,7,8],   [1,2,7,9],   [1,2,7,10],   [1,2,7,11],   [1,2,7,12],   [1,2,8,8],   [1,2,8,9],
  [1,2,8,10],   [1,2,8,13],   [1,2,9,11],   [1,2,9,12],   [1,2,9,13],   [1,2,10,11],   [1,2,10,12],   [1,2,10,13],
  [1,2,11,11],   [1,2,11,12],   [1,2,11,13],   [1,2,12,12],   [1,2,12,13],   [1,2,13,13],   [1,3,3,3],   [1,3,3,4],
  [1,3,3,5],   [1,3,3,6],   [1,3,3,7],   [1,3,3,8],   [1,3,3,9],   [1,3,3,10],   [1,3,3,11],   [1,3,3,12],
  [1,3,4,4],   [1,3,4,5],   [1,3,4,6],   [1,3,4,7],   [1,3,4,8],   [1,3,4,9],   [1,3,4,10],   [1,3,4,11],
  [1,3,4,12],   [1,3,4,13],   [1,3,5,6],   [1,3,5,7],   [1,3,5,8],   [1,3,5,9],   [1,3,5,10],   [1,3,5,11],
  [1,3,5,12],   [1,3,5,13],   [1,3,6,6],   [1,3,6,7],   [1,3,6,8],   [1,3,6,9],   [1,3,6,10],   [1,3,6,11],
  [1,3,6,12],   [1,3,6,13],   [1,3,7,7],   [1,3,7,8],   [1,3,7,9],   [1,3,7,10],   [1,3,7,12],   [1,3,7,13],
  [1,3,8,8],   [1,3,8,9],   [1,3,8,10],   [1,3,8,11],   [1,3,8,12],   [1,3,8,13],   [1,3,9,9],   [1,3,9,10],
  [1,3,9,11],   [1,3,9,12],   [1,3,9,13],   [1,3,10,10],   [1,3,10,11],   [1,3,10,12],   [1,3,11,11],   [1,3,11,12],
  [1,3,12,12],   [1,3,12,13],   [1,3,13,13],   [1,4,4,4],   [1,4,4,5],   [1,4,4,6],   [1,4,4,7],   [1,4,4,8],
  [1,4,4,9],   [1,4,4,10],   [1,4,4,11],   [1,4,4,12],   [1,4,5,5],   [1,4,5,6],   [1,4,5,7],   [1,4,5,8],
  [1,4,5,9],   [1,4,5,10],   [1,4,5,11],   [1,4,5,12],   [1,4,5,13],   [1,4,6,6],   [1,4,6,7],   [1,4,6,8],
  [1,4,6,9],   [1,4,6,10],   [1,4,6,11],   [1,4,6,12],   [1,4,6,13],   [1,4,7,7],   [1,4,7,8],   [1,4,7,9],
  [1,4,7,11],   [1,4,7,12],   [1,4,7,13],   [1,4,8,8],   [1,4,8,9],   [1,4,8,11],   [1,4,8,12],   [1,4,8,13],
  [1,4,9,10],   [1,4,9,11],   [1,4,9,12],   [1,4,9,13],   [1,4,10,10],   [1,4,10,11],   [1,4,10,12],   [1,4,12,12],
  [1,5,5,5],   [1,5,5,6],   [1,5,5,9],   [1,5,5,10],   [1,5,5,11],   [1,5,5,12],   [1,5,5,13],   [1,5,6,6],
  [1,5,6,7],   [1,5,6,8],   [1,5,6,9],   [1,5,6,10],   [1,5,6,11],   [1,5,6,12],   [1,5,6,13],   [1,5,7,8],
  [1,5,7,9],   [1,5,7,10],   [1,5,7,11],   [1,5,7,12],   [1,5,7,13],   [1,5,8,8],   [1,5,8,9],   [1,5,8,10],
  [1,5,8,11],   [1,5,8,12],   [1,5,8,13],   [1,5,9,9],   [1,5,9,10],   [1,5,9,11],   [1,5,9,12],   [1,5,9,13],
  [1,5,10,10],   [1,5,10,11],   [1,5,10,12],   [1,5,10,13],   [1,5,11,11],   [1,5,11,12],   [1,5,12,12],   [1,6,6,6],
  [1,6,6,8],   [1,6,6,9],   [1,6,6,10],   [1,6,6,11],   [1,6,6,12],   [1,6,6,13],   [1,6,7,9],   [1,6,7,10],
  [1,6,7,11],   [1,6,7,12],   [1,6,8,8],   [1,6,8,9],   [1,6,8,10],   [1,6,8,11],   [1,6,8,12],   [1,6,8,13],
  [1,6,9,9],   [1,6,9,10],   [1,6,9,12],   [1,6,9,13],   [1,6,10,12],   [1,6,10,13],   [1,6,11,12],   [1,6,11,13],
  [1,6,12,12],   [1,6,12,13],   [1,7,7,9],   [1,7,7,10],   [1,7,7,11],   [1,7,7,12],   [1,7,8,8],   [1,7,8,9],
  [1,7,8,10],   [1,7,8,11],   [1,7,8,12],   [1,7,9,9],   [1,7,9,10],   [1,7,9,11],   [1,7,9,12],   [1,7,9,13],
  [1,7,10,12],   [1,7,10,13],   [1,7,12,12],   [1,7,12,13],   [1,7,13,13],   [1,8,8,8],   [1,8,8,9],   [1,8,8,10],
  [1,8,8,11],   [1,8,8,12],   [1,8,9,11],   [1,8,9,12],   [1,8,9,13],   [1,8,10,11],   [1,8,10,12],   [1,8,10,13],
  [1,8,11,12],   [1,8,11,13],   [1,8,12,12],   [1,9,9,12],   [1,9,10,12],   [1,9,10,13],   [1,9,11,11],   [1,9,11,12],
  [1,9,11,13],   [1,9,12,12],   [1,10,10,12],   [1,10,11,12],   [1,10,12,12],   [1,10,12,13],   [1,11,11,12],   [1,11,11,13],
  [1,11,12,12],   [1,11,12,13],   [1,11,13,13],   [1,12,12,12],   [1,12,12,13],   [1,12,13,13],   [2,2,2,3],   [2,2,2,4],
  [2,2,2,5],   [2,2,2,7],   [2,2,2,8],   [2,2,2,9],   [2,2,2,10],   [2,2,2,11],   [2,2,2,12],   [2,2,2,13],
  [2,2,3,3],   [2,2,3,4],   [2,2,3,5],   [2,2,3,6],   [2,2,3,7],   [2,2,3,8],   [2,2,3,9],   [2,2,3,10],
  [2,2,3,11],   [2,2,3,12],   [2,2,3,13],   [2,2,4,4],   [2,2,4,5],   [2,2,4,6],   [2,2,4,7],   [2,2,4,8],
  [2,2,4,9],   [2,2,4,10],   [2,2,4,11],   [2,2,4,12],   [2,2,4,13],   [2,2,5,5],   [2,2,5,6],   [2,2,5,7],
  [2,2,5,8],   [2,2,5,9],   [2,2,5,10],   [2,2,5,11],   [2,2,5,12],   [2,2,6,6],   [2,2,6,7],   [2,2,6,8],
  [2,2,6,9],   [2,2,6,10],   [2,2,6,11],   [2,2,6,12],   [2,2,6,13],   [2,2,7,7],   [2,2,7,8],   [2,2,7,10],
  [2,2,7,12],   [2,2,7,13],   [2,2,8,8],   [2,2,8,9],   [2,2,8,10],   [2,2,8,12],   [2,2,9,10],   [2,2,9,11],
  [2,2,9,12],   [2,2,10,10],   [2,2,10,11],   [2,2,10,13],   [2,2,11,11],   [2,2,11,12],   [2,2,11,13],   [2,2,12,12],
  [2,2,12,13],   [2,2,13,13],   [2,3,3,3],   [2,3,3,5],   [2,3,3,6],   [2,3,3,7],   [2,3,3,8],   [2,3,3,9],
  [2,3,3,10],   [2,3,3,11],   [2,3,3,12],   [2,3,3,13],   [2,3,4,4],   [2,3,4,5],   [2,3,4,6],   [2,3,4,7],
  [2,3,4,8],   [2,3,4,9],   [2,3,4,10],   [2,3,4,11],   [2,3,4,12],   [2,3,4,13],   [2,3,5,5],   [2,3,5,6],
  [2,3,5,7],   [2,3,5,8],   [2,3,5,9],   [2,3,5,10],   [2,3,5,11],   [2,3,5,12],   [2,3,5,13],   [2,3,6,6],
  [2,3,6,7],   [2,3,6,8],   [2,3,6,9],   [2,3,6,10],   [2,3,6,11],   [2,3,6,12],   [2,3,6,13],   [2,3,7,7],
  [2,3,7,8],   [2,3,7,9],   [2,3,7,10],   [2,3,7,11],   [2,3,7,12],   [2,3,7,13],   [2,3,8,8],   [2,3,8,9],
  [2,3,8,10],   [2,3,8,11],   [2,3,8,12],   [2,3,8,13],   [2,3,9,9],   [2,3,9,10],   [2,3,9,12],   [2,3,9,13],
  [2,3,10,10],   [2,3,10,12],   [2,3,10,13],   [2,3,11,11],   [2,3,11,12],   [2,3,11,13],   [2,3,12,12],   [2,3,12,13],
  [2,3,13,13],   [2,4,4,4],   [2,4,4,5],   [2,4,4,6],   [2,4,4,7],   [2,4,4,8],   [2,4,4,9],   [2,4,4,10],
  [2,4,4,11],   [2,4,4,12],   [2,4,4,13],   [2,4,5,5],   [2,4,5,6],   [2,4,5,7],   [2,4,5,8],   [2,4,5,9],
  [2,4,5,10],   [2,4,5,11],   [2,4,5,12],   [2,4,5,13],   [2,4,6,6],   [2,4,6,7],   [2,4,6,8],   [2,4,6,9],
  [2,4,6,10],   [2,4,6,11],   [2,4,6,12],   [2,4,6,13],   [2,4,7,7],   [2,4,7,8],   [2,4,7,9],   [2,4,7,10],
  [2,4,7,11],   [2,4,7,12],   [2,4,8,8],   [2,4,8,9],   [2,4,8,10],   [2,4,8,11],   [2,4,8,12],   [2,4,8,13],
  [2,4,9,9],   [2,4,9,10],   [2,4,9,12],   [2,4,9,13],   [2,4,10,10],   [2,4,10,11],   [2,4,10,12],   [2,4,10,13],
  [2,4,11,11],   [2,4,11,12],   [2,4,12,12],   [2,4,13,13],   [2,5,5,7],   [2,5,5,8],   [2,5,5,9],   [2,5,5,10],
  [2,5,5,11],   [2,5,5,12],   [2,5,5,13],   [2,5,6,6],   [2,5,6,7],   [2,5,6,8],   [2,5,6,9],   [2,5,6,10],
  [2,5,6,11],   [2,5,6,12],   [2,5,6,13],   [2,5,7,7],   [2,5,7,8],   [2,5,7,9],   [2,5,7,10],   [2,5,7,11],
  [2,5,7,13],   [2,5,8,8],   [2,5,8,9],   [2,5,8,10],   [2,5,8,11],   [2,5,8,12],   [2,5,8,13],   [2,5,9,10],
  [2,5,9,11],   [2,5,9,12],   [2,5,10,10],   [2,5,10,11],   [2,5,10,12],   [2,5,10,13],   [2,5,11,12],   [2,5,12,12],
  [2,5,12,13],   [2,6,6,6],   [2,6,6,7],   [2,6,6,8],   [2,6,6,9],   [2,6,6,10],   [2,6,6,11],   [2,6,6,12],
  [2,6,6,13],   [2,6,7,8],   [2,6,7,9],   [2,6,7,10],   [2,6,7,11],   [2,6,7,12],   [2,6,7,13],   [2,6,8,8],
  [2,6,8,9],   [2,6,8,10],   [2,6,8,11],   [2,6,8,12],   [2,6,8,13],   [2,6,9,9],   [2,6,9,10],   [2,6,9,11],
  [2,6,9,12],   [2,6,10,10],   [2,6,10,11],   [2,6,10,12],   [2,6,10,13],   [2,6,11,12],   [2,6,11,13],   [2,6,12,12],
  [2,6,12,13],   [2,7,7,8],   [2,7,7,10],   [2,7,7,11],   [2,7,7,12],   [2,7,7,13],   [2,7,8,8],   [2,7,8,9]
]

Page({
  /**
   * 页面的初始数据
   * 包含场景数据、当前选中状态、游戏详情等
   */
  data: {
    // 当前选中的场景：存放场景 key，例如：'过年'、'结婚'
    selectedScene: null,
    
    // 当前生成的游戏详情
    currentGame: null,
    
    // 24点算术相关数据
    showGame24: false,
    game24Numbers: [],
    game24Expression: '',
    game24Message: '',
    game24MessageType: '',
    game24Answer: '',
    
    // 弹窗控制标志
    isShowingWelcomeModal: false,
    
    // 场景列表（用于渲染顶部场景按钮，方便后续继续扩展）
    sceneList: [
      { key: '过年', label: '过年 🧧' },
      { key: '结婚', label: '结婚 💒' },
      { key: '生日派对', label: '生日派对 🎂' },
      { key: '家庭聚会', label: '家庭聚会 🏠' },
      { key: '公司团建', label: '公司团建 🏢' },
      { key: '同学聚会', label: '同学聚会 🎓' },
      { key: 'KTV酒吧', label: 'KTV / 酒吧 🎤' },
      { key: '户外活动', label: '户外活动 🏕️' }
    ],
    
    // 场景游戏数据源
    sceneGames: {
      '过年': [
        {
          name: '抢红包',
          desc: '经典过年互动游戏，考验反应速度和运气',
          people: '3-10人',
          props: ['红包（纸质或电子）', '计时器', '音乐'],
          rules: [
            '主持人准备多个红包，其中一部分装有奖励',
            '参与者围成一圈，音乐响起时传递红包',
            '音乐停止时，手持红包的人可以打开',
            '获得奖励者需要表演小节目或说祝福语',
            '可以设置多轮，增加趣味性'
          ]
        },
        {
          name: '新年祝福接龙',
          desc: '创意祝福语接龙，锻炼语言表达能力',
          people: '4-12人',
          props: ['计时器', '记录纸（可选）'],
          rules: [
            '参与者轮流说出包含"新年"或"年"字的祝福语',
            '前一个人说完后，后一个人必须在3秒内接上',
            '祝福语不能重复，必须带有正能量',
            '接不上或重复的参与者出局',
            '最后留下的3人获得新年礼物'
          ]
        },
        {
          name: '年货大采购',
          desc: '趣味角色扮演游戏，模拟年货采购场景',
          people: '5-8人',
          props: ['卡片或纸条（代表商品）', '代币或积分'],
          rules: [
            '设定多种年货商品（糖果、坚果、春联等）',
            '每个参与者分配固定预算，需要采购指定数量的商品',
            '通过竞拍、交换等方式获得商品',
            '在规定时间内完成采购任务者获胜',
            '可以设置特殊事件（打折、限购等）增加难度'
          ]
        },
        {
          name: '爆竹传花',
          desc: '结合传统元素的音乐传物游戏',
          people: '6-15人',
          props: ['音乐设备', '道具花或小物品'],
          rules: [
            '参与者围成圆圈，传递道具',
            '音乐响起时开始传递，停止时手持道具者需要表演',
            '表演内容可以是新年祝福、才艺展示或小游戏',
            '表演完成后，由该参与者决定下一轮传递方向',
            '可以准备小礼品奖励表演者'
          ]
        },
        {
          name: '春联对对碰',
          desc: '创意春联创作和配对游戏，考验文学功底',
          people: '4-10人',
          props: ['红纸', '毛笔或马克笔', '计时器'],
          rules: [
            '分成两组，每组轮流创作上联或下联',
            '对方组需要在限定时间内对出下联或上联',
            '对仗工整、寓意吉祥的得分更高',
            '可以设置主题，如"家庭和睦""事业顺利"等',
            '得分最高的一组获得新年大礼包'
          ]
        },
        {
          name: '年夜饭大竞猜',
          desc: '通过描述猜菜名，增加年夜饭趣味性',
          people: '5-15人',
          props: ['菜品卡片', '计时器'],
          rules: [
            '准备多张年夜饭常见菜品的卡片',
            '一人描述菜品特征（不能直接说菜名），其他人抢答',
            '猜对者得分，描述者也可以得分',
            '可以设置难度等级，如"年年有余"（鱼）等谐音题',
            '得分最高者获得"美食家"称号'
          ]
        },
        {
          name: '守岁倒计时',
          desc: '跨年倒计时前的互动小游戏',
          people: '不限',
          props: ['计时器', '心愿卡片', '许愿箱'],
          rules: [
            '在跨年倒计时前30分钟开始',
            '每人写下新年愿望，投入许愿箱',
            '轮流抽取愿望并大声念出，大家一起祝福',
            '可以设置"愿望实现挑战"，如"今年要旅行3次"等',
            '倒计时时一起许愿，增加仪式感'
          ]
        },
        {
          name: '生肖大转盘',
          desc: '结合生肖元素的转盘抽奖游戏',
          people: '6-20人',
          props: ['转盘（可自制）', '指针', '奖品'],
          rules: [
            '制作一个包含12生肖的转盘',
            '每个生肖对应不同的任务或奖励',
            '参与者轮流转动转盘，完成对应任务',
            '任务可以是"表演节目""说祝福语""分享新年计划"等',
            '完成任务的参与者获得小礼品'
          ]
        },
        {
          name: '新年愿望树',
          desc: '大家一起装饰许愿树，写下新年愿望',
          people: '3-20人',
          props: ['许愿树（可自制）', '便签纸', '笔', '装饰品'],
          rules: [
            '准备一棵小树或画一棵树在墙上',
            '每人写下1-3个新年愿望，贴在树上',
            '可以设置愿望主题，如"健康""事业""家庭"等',
            '大家一起装饰许愿树，拍照留念',
            '年底可以回顾愿望实现情况'
          ]
        },
        {
          name: '猜灯谜',
          desc: '传统猜灯谜游戏，考验智力',
          people: '4-12人',
          props: ['灯谜卡片', '计时器', '小奖品'],
          rules: [
            '准备多道灯谜，难度从易到难',
            '主持人念出灯谜，参与者抢答',
            '答对者得分，答错者扣分或出局',
            '可以设置"提示卡"，答错后可用提示',
            '得分最高者获得"智慧之星"称号'
          ]
        },
        {
          name: '新年祝福接力',
          desc: '用肢体语言传递新年祝福语',
          people: '6-15人',
          props: ['祝福语卡片'],
          rules: [
            '分成两组，每组站成一排',
            '第一个人看卡片上的祝福语，用动作传递给下一个人',
            '最后一个人猜出祝福语，猜对得分',
            '不能说话，只能用动作和表情',
            '传递最准确、猜对最多的一组获胜'
          ]
        }
      ],
      '结婚': [
        {
          name: '爱情密码',
          desc: '测试新人和宾客默契度的趣味游戏',
          people: '新人+6-10位宾客',
          props: ['答题板或纸笔', '问题卡片'],
          rules: [
            '新郎新娘背对背坐下，回答相同的问题',
            '问题可以是：第一次见面地点、最喜欢的食物、生日等',
            '答案一致得1分，不一致扣1分',
            '宾客也可以参与竞猜，猜对的获得小礼品',
            '分数最高者获得"最佳默契"奖'
          ]
        },
        {
          name: '红包雨',
          desc: '结合电子红包的互动抢红包游戏',
          people: '8-20人',
          props: ['手机微信', '红包群', '投影或大屏（可选）'],
          rules: [
            '创建微信群，提前告知宾客加入',
            '主持人随机在群内发红包，限时抢',
            '抢到红包金额最大的3位宾客上台表演',
            '表演内容可以是祝福、才艺或互动小游戏',
            '也可以设置特殊规则，如"手气最佳者配对游戏"'
          ]
        },
        {
          name: '花式敬酒',
          desc: '创意敬酒方式挑战，增加婚礼趣味性',
          people: '新人+所有宾客',
          props: ['酒杯', '饮品', '挑战卡片'],
          rules: [
            '准备多种创意敬酒方式（单手、蒙眼、接力等）',
            '宾客可以向新人提出敬酒挑战',
            '新人可以选择接受挑战或指定他人完成',
            '完成挑战的宾客获得新人准备的小礼品',
            '可以设置敬酒次数限制，控制节奏'
          ]
        },
        {
          name: '婚礼寻宝',
          desc: '在婚礼现场进行寻宝互动游戏',
          people: '10-30人',
          props: ['藏宝卡片', '线索提示', '奖品'],
          rules: [
            '提前在婚礼现场隐藏多个"藏宝卡片"',
            '每个卡片对应一个线索或直接是奖品',
            '宾客分组或单独行动，寻找卡片',
            '找到卡片后需要完成卡片上的任务才能获得奖品',
            '设置大奖卡片，增加游戏刺激性'
          ]
        },
        {
          name: '新人默契大考验',
          desc: '通过问答测试新人的默契程度',
          people: '新人+8-15位宾客',
          props: ['问题卡片', '答题板', '计分器'],
          rules: [
            '准备关于新人恋爱经历的问题',
            '新郎新娘背对背，同时回答相同问题',
            '答案一致得2分，不一致扣1分',
            '宾客可以参与竞猜，猜对新人答案的得分',
            '得分最高者获得"最了解新人"奖'
          ]
        },
        {
          name: '抛绣球',
          desc: '传统抛绣球游戏，增加婚礼互动性',
          people: '新人+所有单身宾客',
          props: ['绣球或花束', '音乐'],
          rules: [
            '新娘背对宾客，手持绣球',
            '音乐响起，新娘向后抛绣球',
            '抢到绣球的单身宾客上台表演或说祝福',
            '可以设置多轮，增加参与度',
            '抢到绣球者获得新人准备的小礼品'
          ]
        },
        {
          name: '婚礼真心话',
          desc: '新人回答宾客提出的趣味问题',
          people: '新人+所有宾客',
          props: ['问题箱', '抽签盒'],
          rules: [
            '提前收集宾客想问新人的问题，放入问题箱',
            '新人轮流抽取问题并回答',
            '问题可以是"第一次约会地点""谁先表白的"等',
            '回答后可以请提问者分享相关故事',
            '增加现场互动和趣味性'
          ]
        },
        {
          name: '爱的传递',
          desc: '用接力的方式传递对新人的祝福',
          people: '10-30人',
          props: ['祝福卡片', '音乐'],
          rules: [
            '宾客围成圆圈，传递祝福卡片',
            '音乐停止时，手持卡片者说出对新人的祝福',
            '祝福内容不能重复，必须真诚',
            '可以设置"特殊祝福"，如"用方言说""用歌曲唱"等',
            '所有祝福收集后送给新人作为纪念'
          ]
        },
        {
          name: '婚礼快问快答',
          desc: '关于新人恋爱史的快速问答游戏',
          people: '新人+6-15位宾客',
          props: ['问题卡片', '抢答器或举手'],
          rules: [
            '主持人提问关于新人的问题',
            '宾客抢答，答对得分',
            '新人也可以参与，答对得分翻倍',
            '问题包括"第一次见面时间""求婚地点"等',
            '得分最高者获得"新人知心好友"奖'
          ]
        },
        {
          name: '爱的拼图',
          desc: '用新人照片制作拼图，宾客合作完成',
          people: '8-20人',
          props: ['新人照片拼图', '计时器'],
          rules: [
            '将新人合照制作成拼图，打乱',
            '宾客分组，每组获得部分拼图片段',
            '在规定时间内完成拼图',
            '最快完成的一组获得奖品',
            '完成的拼图可以装裱送给新人'
          ]
        },
        {
          name: '婚礼祝福墙',
          desc: '宾客在祝福墙上写下对新人的祝福',
          people: '不限',
          props: ['祝福墙（可自制）', '便签纸', '笔', '装饰品'],
          rules: [
            '准备一面墙或展板作为祝福墙',
            '每位宾客写下对新人的祝福并贴上',
            '可以设置主题，如"对新人的建议""最想说的话"等',
            '新人可以现场阅读部分祝福',
            '祝福墙可以拍照留念，作为婚礼纪念'
          ]
        },
        {
          name: '新人模仿秀',
          desc: '宾客模仿新人的经典动作或话语',
          people: '6-15人',
          props: ['模仿卡片', '小道具'],
          rules: [
            '准备新人的经典动作或话语卡片',
            '宾客抽取卡片，模仿新人的行为',
            '其他宾客猜模仿的是谁（新郎/新娘）',
            '模仿最像、猜对最多的获得奖品',
            '增加现场欢乐氛围'
          ]
        }
      ],
      // 生日派对场景
      '生日派对': [
        {
          name: '生日愿望盲猜',
          desc: '大家写下对寿星的猜测愿望，看谁最了解寿星',
          people: '4-15人',
          props: ['便签纸', '笔', '收集盒'],
          rules: [
            '每位宾客写下自己认为寿星今年最大的一个愿望',
            '寿星也秘密写下自己的真实愿望',
            '主持人随机念出愿望，让大家猜哪一个才是真的',
            '猜中的玩家获得小礼物，寿星可以选择公开或保留愿望'
          ]
        },
        {
          name: '吹蜡烛挑战赛',
          desc: '围绕生日蛋糕和蜡烛设计的小挑战',
          people: '3-10人',
          props: ['生日蛋糕', '蜡烛若干'],
          rules: [
            '设置不同距离的蜡烛，寿星需要在一次呼吸内尽量吹灭更多蜡烛',
            '其他玩家也可以参与挑战，看看谁的“肺活量”最强',
            '可设置趣味规则，如单脚站立吹、闭眼吹等',
            '吹灭最多蜡烛者获得趣味称号'
          ]
        },
        {
          name: '童年照片大公开',
          desc: '用猜照片的方式回顾寿星的成长经历',
          people: '4-20人',
          props: ['寿年少时照片若干', '投影或手机'],
          rules: [
            '提前收集寿星从小到大的几张照片',
            '随机展示一张，让大家猜当时发生了什么故事或大概年龄',
            '寿星讲述真实故事，与大家分享童年趣事'
          ]
        },
        {
          name: '礼物盲选',
          desc: '所有礼物统一包装，寿星凭感觉挑选',
          people: '3-12人',
          props: ['统一包装纸', '礼物若干'],
          rules: [
            '所有宾客将礼物统一包装，不能看出里面是什么',
            '寿星通过摇晃、触摸等方式，从外观判断并选择一个打开',
            '其余礼物可以通过小游戏或抽签方式再分配'
          ]
        },
        {
          name: '生日真心话转瓶子',
          desc: '用旋转瓶子决定谁来回答与寿星相关的问题',
          people: '4-12人',
          props: ['空瓶一个', '问题卡片'],
          rules: [
            '大家围坐成圈，将空瓶放在中间',
            '轮流旋转瓶子，瓶口指向谁，谁抽取一张问题卡回答',
            '问题内容围绕寿星，如“第一次见寿星的印象”“最想对寿星说的话”等'
          ]
        },
        {
          name: '一分钟才艺秀',
          desc: '所有宾客轮流上场，为寿星献上一分钟表演',
          people: '5-20人',
          props: ['音乐设备（可选）', '小道具若干'],
          rules: [
            '每个人准备一个一分钟以内的小才艺或小表演',
            '表演内容可以是唱歌、讲笑话、模仿秀等',
            '寿星作为评委，选出“最佳用心奖”和“最搞笑奖”'
          ]
        },
        {
          name: '气球墙打卡',
          desc: '用五颜六色的气球打造拍照打卡区',
          people: '不限',
          props: ['彩色气球', '双面胶或绑绳', '背景布（可选）'],
          rules: [
            '在墙面或背景布上布置成色彩丰富的气球墙',
            '每位来宾到场时在气球墙前拍照并说一句祝福语',
            '可以设置最佳照片评选或集赞活动'
          ]
        },
        {
          name: '生日愿望瓶',
          desc: '将愿望写在纸条上放入许愿瓶，年底打开',
          people: '3-15人',
          props: ['透明瓶子', '彩色纸条', '笔'],
          rules: [
            '每人写下1-3个生日愿望，折好放入许愿瓶',
            '可以设置愿望主题，如"健康""事业""爱情"等',
            '许愿瓶封存，约定一年后打开查看',
            '可以拍照记录，年底回顾愿望实现情况'
          ]
        },
        {
          name: '寿星模仿秀',
          desc: '宾客模仿寿星的经典动作或口头禅',
          people: '5-15人',
          props: ['模仿卡片', '小道具'],
          rules: [
            '准备寿星的经典动作或口头禅卡片',
            '宾客抽取卡片，模仿寿星的行为',
            '其他宾客猜模仿的是什么',
            '模仿最像、猜对最多的获得奖品'
          ]
        },
        {
          name: '生日时间胶囊',
          desc: '写下给未来自己的话，封存起来',
          people: '3-20人',
          props: ['时间胶囊盒', '信纸', '笔', '密封袋'],
          rules: [
            '每人写一封给一年后自己的信',
            '可以写下目标、愿望、想说的话等',
            '统一封存，约定一年后打开',
            '可以设置多个时间点，如"3年后""5年后"等'
          ]
        },
        {
          name: '生日祝福接龙',
          desc: '用接龙的方式传递对寿星的祝福',
          people: '6-20人',
          props: ['祝福卡片', '音乐'],
          rules: [
            '宾客围成圆圈，传递祝福卡片',
            '音乐停止时，手持卡片者说出对寿星的祝福',
            '祝福内容不能重复，必须真诚',
            '可以设置"特殊祝福"，如"用方言说""用歌曲唱"等'
          ]
        },
        {
          name: '生日快问快答',
          desc: '关于寿星的快速问答游戏',
          people: '5-15人',
          props: ['问题卡片', '抢答器或举手'],
          rules: [
            '主持人提问关于寿星的问题',
            '宾客抢答，答对得分',
            '问题包括"最喜欢的食物""最难忘的经历"等',
            '得分最高者获得"最了解寿星"奖'
          ]
        }
      ],
      // 家庭聚会场景
      '家庭聚会': [
        {
          name: '家庭版谁是卧底',
          desc: '适合老少同乐的轻量版推理游戏',
          people: '4-12人',
          props: ['词语卡片或手机App'],
          rules: [
            '为避免难度过高，选择生活化、家庭化的词语',
            '每轮发放相同词语给大多数人，给一人发放相近但不同的词语作为卧底',
            '轮流描述自己拿到的词语但不能说出词语本身'
          ]
        },
        {
          name: '家庭记忆接龙',
          desc: '通过讲家庭故事加强家人之间的情感连接',
          people: '3-10人',
          props: [],
          rules: [
            '以“我记得某一年过年……”或“我和某某的有趣回忆是……”为开头',
            '每个人必须接着前一个人的话题讲述新的记忆片段'
          ]
        },
        {
          name: '家庭厨神大比拼',
          desc: '比拼谁做的小菜最受欢迎',
          people: '3-8人',
          props: ['厨房工具', '简单食材'],
          rules: [
            '事先准备好几种基础食材，确保操作简单安全',
            '每位参赛者在限定时间内完成一道小菜或摆盘'
          ]
        },
        {
          name: '家庭照片拼图',
          desc: '把家庭合照做成拼图重新拼接',
          people: '2-6人',
          props: ['打印照片', '剪刀', '信封'],
          rules: [
            '将家庭合照打印后剪成若干块，装入信封',
            '计时看谁在最短时间内完成拼图'
          ]
        },
        {
          name: '代际问答赛',
          desc: '长辈问年轻人“旧知识”，年轻人问长辈“新潮流”',
          people: '4-12人',
          props: ['题目卡片'],
          rules: [
            '长辈准备一些关于老歌、老电影、年代事件的问题',
            '年轻人准备一些关于网络热词、流行文化的问题'
          ]
        },
        {
          name: '家庭角色互换',
          desc: '用角色扮演的方式体验彼此的日常',
          people: '3-8人',
          props: ['简单道具（眼镜、帽子等）'],
          rules: [
            '随机抽取家庭成员的角色，如"爸爸""妈妈""孩子"等',
            '每个人用 1 分钟时间表演自己抽到角色的一天'
          ]
        },
        {
          name: '家庭版你画我猜',
          desc: '用画画的方式猜家庭相关的词语',
          people: '4-12人',
          props: ['白板或纸', '笔', '词语卡片'],
          rules: [
            '分成两组，每组轮流派一人画画',
            '画的人不能说话，只能画图',
            '队友猜词语，猜对得分',
            '词语可以是"家庭用品""家庭成员""家庭活动"等'
          ]
        },
        {
          name: '家庭故事会',
          desc: '轮流分享家庭趣事，增进感情',
          people: '3-10人',
          props: ['故事卡片（可选）'],
          rules: [
            '每人准备一个家庭相关的有趣故事',
            '轮流分享，其他人可以提问或补充',
            '可以设置主题，如"最搞笑的家庭瞬间""最感动的时刻"等',
            '分享后大家一起讨论，增加互动'
          ]
        },
        {
          name: '家庭默契大考验',
          desc: '测试家庭成员之间的默契程度',
          people: '4-12人',
          props: ['问题卡片', '答题板'],
          rules: [
            '准备关于家庭的问题，如"妈妈最喜欢吃什么"等',
            '家庭成员同时回答，答案一致得分',
            '可以设置难度等级，增加挑战性',
            '得分最高者获得"家庭默契王"称号'
          ]
        },
        {
          name: '家庭版传话游戏',
          desc: '用传话的方式传递家庭信息',
          people: '5-15人',
          props: ['传话卡片'],
          rules: [
            '分成两组，每组站成一排',
            '第一个人看卡片上的话，悄悄传给下一个人',
            '最后一个人说出听到的话，与原文对比',
            '传递最准确的一组获胜'
          ]
        },
        {
          name: '家庭才艺展示',
          desc: '每个家庭成员展示自己的才艺',
          people: '3-10人',
          props: ['才艺道具（可选）'],
          rules: [
            '每人准备一个才艺展示，如唱歌、跳舞、讲笑话等',
            '轮流表演，其他人作为观众',
            '可以设置"最佳才艺奖""最搞笑奖"等',
            '增加家庭欢乐氛围'
          ]
        },
        {
          name: '家庭版真心话大冒险',
          desc: '适合家庭的轻量版真心话大冒险',
          people: '4-12人',
          props: ['问题卡片', '挑战卡片'],
          rules: [
            '准备适合家庭的问题和挑战',
            '轮流抽取卡片，选择"真心话"或"大冒险"',
            '问题要温馨，挑战要安全有趣',
            '增加家庭成员之间的了解'
          ]
        }
      ],
      // 公司团建场景
      '公司团建': [
        {
          name: '名字加印象',
          desc: '破冰游戏，帮助新人快速记住彼此',
          people: '6-30人',
          props: [],
          rules: [
            '所有人围成一圈，依次说出“我是XX，我的一个关键词是XX”',
            '下一位需要重复前面所有人的名字+关键词，再补充自己'
          ]
        },
        {
          name: '团队建筑师',
          desc: '用有限材料搭建最高或最稳定的“建筑”',
          people: '8-24人',
          props: ['纸杯', '胶带', '纸张', '吸管等简易材料'],
          rules: [
            '分成若干小组，每组获得相同材料',
            '在限定时间内搭建一座尽可能高或能承重的小塔'
          ]
        },
        {
          name: '办公室版狼人/卧底',
          desc: '融入职场元素的推理游戏',
          people: '6-18人',
          props: ['身份牌', '计时器'],
          rules: [
            '根据团队氛围选择“谁是卧底”或“狼人杀”等规则',
            '可将身份替换为“产品经理”“测试”“运营”等岗位称呼'
          ]
        },
        {
          name: '团队解密任务',
          desc: '通过解谜题完成“任务线”，锻炼团队合作',
          people: '6-20人',
          props: ['打印好的谜题卡', '线索道具'],
          rules: [
            '准备若干与公司业务或日常趣事相关的谜题',
            '每解开一个谜题，就能获得下一个线索'
          ]
        },
        {
          name: '无声排序',
          desc: '禁止说话，只能用肢体语言完成排序任务',
          people: '6-20人',
          props: ['题目提示卡'],
          rules: [
            '给每人发放一张写有数字或日期的卡片，不能让别人看到',
            '所有人禁止说话，只能通过肢体或表情交流'
          ]
        },
        {
          name: '极速演讲',
          desc: '锻炼表达能力和随机应变能力的小游戏',
          people: '4-15人',
          props: ['主题卡片', '计时器'],
          rules: [
            '准备一批与工作或生活相关的随机主题',
            '参与者抽到主题后，需要在 30 秒内即兴演讲'
          ]
        },
        {
          name: '团队信任背摔',
          desc: '经典的团队信任游戏，增强团队凝聚力',
          people: '8-20人',
          props: ['安全垫（可选）'],
          rules: [
            '一人站在高处，背对团队向后倒',
            '团队成员用手接住，确保安全',
            '完成后分享感受，讨论信任的重要性',
            '注意安全，确保有足够的人接住'
          ]
        },
        {
          name: '办公室版你画我猜',
          desc: '用画画的方式猜职场相关词语',
          people: '6-18人',
          props: ['白板或纸', '笔', '词语卡片'],
          rules: [
            '分成两组，每组轮流派一人画画',
            '画的人不能说话，只能画图',
            '队友猜词语，猜对得分',
            '词语可以是"工作用品""职位名称""工作场景"等'
          ]
        },
        {
          name: '团队拼图挑战',
          desc: '分组完成拼图，考验团队协作',
          people: '8-24人',
          props: ['拼图若干', '计时器'],
          rules: [
            '分成若干小组，每组获得相同难度的拼图',
            '在规定时间内完成拼图',
            '最快完成的一组获胜',
            '可以设置奖励，增加竞争性'
          ]
        },
        {
          name: '职场版狼人杀',
          desc: '融入职场元素的推理游戏',
          people: '8-18人',
          props: ['身份牌', '计时器'],
          rules: [
            '将身份替换为"老板""员工""HR"等职场角色',
            '根据团队氛围调整游戏规则',
            '增加职场元素，如"项目会议""绩效考核"等',
            '锻炼逻辑思维和表达能力'
          ]
        },
        {
          name: '团队创意海报',
          desc: '分组设计创意海报，展示团队文化',
          people: '8-24人',
          props: ['大纸', '彩笔', '装饰材料'],
          rules: [
            '分成若干小组，每组设计一张团队海报',
            '海报主题可以是"团队口号""团队目标"等',
            '在规定时间内完成，然后展示和评选',
            '最佳海报获得奖品'
          ]
        },
        {
          name: '团队接力挑战',
          desc: '多种小任务组成的接力挑战',
          people: '10-30人',
          props: ['任务卡片', '道具若干'],
          rules: [
            '分成若干小组，每组完成一系列任务',
            '任务包括"解谜题""做动作""回答问题"等',
            '完成一个任务才能获得下一个任务',
            '最快完成所有任务的小组获胜'
          ]
        }
      ],
      // 同学聚会场景
      '同学聚会': [
        {
          name: '校园回忆快问快答',
          desc: '围绕学生时代回忆的抢答游戏',
          people: '5-20人',
          props: ['题目卡片', '抢答器或举手抢答'],
          rules: [
            '题目内容包括“谁上课最爱睡觉”“哪个老师最严格”等',
            '答题者需要说出具体人名或事件'
          ]
        },
        {
          name: '重写同学录',
          desc: '用成年后的视角补写当年的同学录',
          people: '4-15人',
          props: ['小卡片', '笔'],
          rules: [
            '每人抽取一位同学的名字，匿名写下现在想对 TA 说的话',
            '统一收集后随机念出内容，让大家猜是写给谁的'
          ]
        },
        {
          name: '班级记忆时间线',
          desc: '一起还原那几年的关键事件',
          people: '5-20人',
          props: ['便利贴', '长纸条或白板'],
          rules: [
            '在纸上画出时间轴，从入学到毕业',
            '每个人写下自己印象最深的一个班级事件贴在时间轴上'
          ]
        },
        {
          name: '谁是改变最大的人',
          desc: '通过线索猜出同学这些年的变化',
          people: '5-20人',
          props: ['个人变化小卡片'],
          rules: [
            '每人写下一个自己这几年最大的变化，如“换了三份工作”等',
            '主持人打乱顺序后随机念出内容，让大家猜是谁写的'
          ]
        },
        {
          name: '校园 BGM 大合唱',
          desc: '点播学生时代流行歌曲，一起合唱',
          people: '不限',
          props: ['音响设备', '歌曲列表'],
          rules: [
            '大家轮流点歌，优先选择学生时代最常听的歌曲',
            '可以分成合唱、小组对唱、个人 solo 等形式'
          ]
        },
        {
          name: '未来同学录',
          desc: '给 10 年后的自己和同学写一句话',
          people: '3-20人',
          props: ['信纸或卡片', '信封'],
          rules: [
            '每人写一封给十年后自己和同学的小短信',
            '统一封存，可以交给组织者保管或拍照保存'
          ]
        },
        {
          name: '校园版你画我猜',
          desc: '用画画的方式猜校园相关词语',
          people: '6-18人',
          props: ['白板或纸', '笔', '词语卡片'],
          rules: [
            '分成两组，每组轮流派一人画画',
            '画的人不能说话，只能画图',
            '队友猜词语，猜对得分',
            '词语可以是"校园建筑""老师名字""校园活动"等'
          ]
        },
        {
          name: '同学模仿秀',
          desc: '模仿同学的经典动作或口头禅',
          people: '6-15人',
          props: ['模仿卡片', '小道具'],
          rules: [
            '准备同学的经典动作或口头禅卡片',
            '参与者抽取卡片，模仿同学的行为',
            '其他同学猜模仿的是谁',
            '模仿最像、猜对最多的获得奖品'
          ]
        },
        {
          name: '校园版真心话大冒险',
          desc: '适合同学聚会的真心话大冒险',
          people: '5-15人',
          props: ['问题卡片', '挑战卡片'],
          rules: [
            '准备适合同学聚会的问题和挑战',
            '轮流抽取卡片，选择"真心话"或"大冒险"',
            '问题围绕学生时代，挑战要安全有趣',
            '增加同学之间的互动和回忆'
          ]
        },
        {
          name: '校园歌曲接龙',
          desc: '用学生时代流行歌曲接龙',
          people: '4-12人',
          props: ['音响设备（可选）'],
          rules: [
            '第一位同学唱一段学生时代的歌曲',
            '下一位同学用最后一个字开头唱另一首歌',
            '在5秒内接不上或重复歌曲则淘汰',
            '最后留下的同学获胜'
          ]
        },
        {
          name: '同学祝福墙',
          desc: '在祝福墙上写下对同学的祝福',
          people: '不限',
          props: ['祝福墙（可自制）', '便签纸', '笔', '装饰品'],
          rules: [
            '准备一面墙或展板作为祝福墙',
            '每位同学写下对其他同学的祝福并贴上',
            '可以设置主题，如"最想说的话""最美好的回忆"等',
            '祝福墙可以拍照留念，作为聚会纪念'
          ]
        },
        {
          name: '校园版快问快答',
          desc: '关于学生时代的快速问答游戏',
          people: '5-20人',
          props: ['问题卡片', '抢答器或举手'],
          rules: [
            '主持人提问关于学生时代的问题',
            '同学抢答，答对得分',
            '问题包括"谁上课最爱睡觉""哪个老师最严格"等',
            '得分最高者获得"校园记忆王"称号'
          ]
        }
      ],
      // KTV / 酒吧场景
      'KTV酒吧': [
        {
          name: '抢唱前奏王',
          desc: '只放前奏，谁先唱出歌名和第一句歌词',
          people: '4-15人',
          props: ['KTV 或音响', '歌曲列表'],
          rules: [
            '随机播放歌曲前奏 3-5 秒，抢先唱对歌名并接上歌词者得分',
            '唱错或跑调严重可由大家投票是否算分'
          ]
        },
        {
          name: '指定风格演唱',
          desc: '用不同风格演绎同一首歌，笑点不断',
          people: '3-10人',
          props: ['歌曲列表'],
          rules: [
            '选定一首大家都熟悉的歌曲',
            '抽签决定演唱风格，如“摇滚版”“撒娇版”“粤语版”等'
          ]
        },
        {
          name: '不准笑挑战',
          desc: '在别人刻意搞笑演唱时坚持不笑',
          people: '4-12人',
          props: [],
          rules: [
            '指定一位挑战者坐在最前排，其他人轮流进行搞笑演唱',
            '挑战者全程不得笑出声或表情明显失守'
          ]
        },
        {
          name: '麦霸传位',
          desc: '由“麦霸”指定下一位接棒人',
          people: '不限',
          props: ['话筒'],
          rules: [
            '当前拿麦者在演唱结束后，需要指定下一位接棒人',
            '可以附带一个小任务，例如“必须唱一首情歌/摇滚/儿歌”等'
          ]
        },
        {
          name: '歌词接龙',
          desc: '用歌词中的最后一个字接下一首歌',
          people: '3-10人',
          props: [],
          rules: [
            '第一位玩家唱一段歌词，下一位玩家需用最后一个字开头唱出另一首歌',
            '在 5 秒内接不上或重复歌曲则淘汰'
          ]
        },
        {
          name: '角色对唱剧场',
          desc: '边唱边演小情景剧',
          people: '4-10人',
          props: ['简单道具（眼镜、帽子等）'],
          rules: [
            '选择一首对唱或合唱歌曲',
            '为每个人分配一个角色，如"老板和员工""老师和学生"等'
          ]
        },
        {
          name: 'KTV版你画我猜',
          desc: '用画画的方式猜歌曲名',
          people: '6-18人',
          props: ['白板或纸', '笔', '歌曲卡片'],
          rules: [
            '分成两组，每组轮流派一人画画',
            '画的人不能说话，只能画图表示歌曲名',
            '队友猜歌曲名，猜对得分',
            '可以设置难度，如"只画一个字""画整首歌"等'
          ]
        },
        {
          name: '歌曲接龙升级版',
          desc: '用歌词中的字接下一首歌，增加难度',
          people: '4-12人',
          props: ['音响设备（可选）'],
          rules: [
            '第一位玩家唱一段歌词',
            '下一位玩家用最后一个字开头唱另一首歌',
            '可以设置规则，如"必须是同一歌手""必须是同一风格"等',
            '在5秒内接不上或重复歌曲则淘汰'
          ]
        },
        {
          name: 'KTV版真心话大冒险',
          desc: '适合KTV环境的真心话大冒险',
          people: '5-15人',
          props: ['问题卡片', '挑战卡片'],
          rules: [
            '准备适合KTV的问题和挑战',
            '轮流抽取卡片，选择"真心话"或"大冒险"',
            '挑战可以是"唱一首指定风格的歌""模仿某个歌手"等',
            '增加KTV氛围的趣味性'
          ]
        },
        {
          name: '歌曲竞猜王',
          desc: '只听前奏猜歌名和歌手',
          people: '4-15人',
          props: ['KTV或音响', '歌曲列表'],
          rules: [
            '随机播放歌曲前奏2-3秒',
            '参与者抢答，说出歌名和歌手',
            '答对得分，答错扣分',
            '可以设置难度，如"只听1秒""只听副歌"等',
            '得分最高者获得"KTV歌神"称号'
          ]
        },
        {
          name: '合唱大比拼',
          desc: '分组进行合唱比赛',
          people: '8-20人',
          props: ['KTV或音响', '歌曲列表'],
          rules: [
            '分成若干小组，每组选择一首合唱歌曲',
            '轮流演唱，其他组作为评委打分',
            '从"音准""配合""创意"等维度评分',
            '得分最高的小组获得奖品'
          ]
        },
        {
          name: 'KTV版传话游戏',
          desc: '用传话的方式传递歌词',
          people: '6-18人',
          props: ['歌词卡片'],
          rules: [
            '分成两组，每组站成一排',
            '第一个人看卡片上的歌词，悄悄传给下一个人',
            '最后一个人说出听到的歌词，与原文对比',
            '传递最准确的一组获胜'
          ]
        }
      ],
      // 户外活动场景
      '户外活动': [
        {
          name: '寻宝定向越野',
          desc: '结合简单导航的户外寻宝游戏',
          people: '6-30人',
          props: ['地图或手机定位', '线索卡片', '小奖品'],
          rules: [
            '在安全范围内预先设置若干“宝藏点”并埋藏线索',
            '参与者分组，根据提示在规定时间内寻找更多线索'
          ]
        },
        {
          name: '气球保卫战',
          desc: '把气球绑在身上，互相踩气球',
          people: '6-20人',
          props: ['气球若干', '细绳'],
          rules: [
            '每位玩家在脚踝处绑上 1-2 个气球',
            '气球全部被踩爆则淘汰'
          ]
        },
        {
          name: '蒙眼找队友',
          desc: '通过声音或暗号找到自己的队友',
          people: '8-24人',
          props: ['眼罩若干'],
          rules: [
            '预先按人数分成若干小队，并给每队一个独特暗号或动物叫声',
            '所有人戴上眼罩，打乱站位'
          ]
        },
        {
          name: '趣味接力赛',
          desc: '在传统接力赛基础上加入搞笑动作',
          people: '8-24人',
          props: ['接力棒或小道具'],
          rules: [
            '分组进行接力，每一棒需要完成不同的指定动作',
            '例如“袋鼠跳”“螃蟹走路”等'
          ]
        },
        {
          name: '飞盘九宫格',
          desc: '将地面划成九宫格，投掷飞盘得分',
          people: '4-16人',
          props: ['飞盘', '地面胶带或粉笔'],
          rules: [
            '在地面划出九宫格并标注不同得分',
            '轮流投掷飞盘，落入对应区域即可获得相应分数'
          ]
        },
        {
          name: '野餐创意摆盘',
          desc: '比拼谁的野餐摆盘最有氛围感',
          people: '3-12人',
          props: ['野餐垫', '食物和饮品', '简单装饰品'],
          rules: [
            '按小组准备各自的野餐区域',
            '从"颜色搭配""创意""拍照效果"等维度进行评选'
          ]
        },
        {
          name: '户外版你画我猜',
          desc: '用画画的方式猜户外相关词语',
          people: '6-18人',
          props: ['白板或纸', '笔', '词语卡片'],
          rules: [
            '分成两组，每组轮流派一人画画',
            '画的人不能说话，只能画图',
            '队友猜词语，猜对得分',
            '词语可以是"户外用品""自然景观""户外活动"等'
          ]
        },
        {
          name: '户外接力挑战',
          desc: '多种户外任务组成的接力挑战',
          people: '10-30人',
          props: ['任务卡片', '道具若干'],
          rules: [
            '分成若干小组，每组完成一系列户外任务',
            '任务包括"找指定物品""完成指定动作""回答自然问题"等',
            '完成一个任务才能获得下一个任务',
            '最快完成所有任务的小组获胜'
          ]
        },
        {
          name: '自然寻宝',
          desc: '在自然环境中寻找指定物品',
          people: '6-20人',
          props: ['寻宝清单', '收集袋'],
          rules: [
            '准备一份寻宝清单，列出要寻找的自然物品',
            '如"一片红色叶子""一块圆石头""一朵小花"等',
            '在规定时间内找到最多物品的小组获胜',
            '注意保护环境，不要破坏自然'
          ]
        },
        {
          name: '户外版真心话大冒险',
          desc: '适合户外环境的真心话大冒险',
          people: '5-15人',
          props: ['问题卡片', '挑战卡片'],
          rules: [
            '准备适合户外的问题和挑战',
            '轮流抽取卡片，选择"真心话"或"大冒险"',
            '挑战可以是"做10个俯卧撑""模仿动物叫声"等',
            '增加户外活动的趣味性'
          ]
        },
        {
          name: '团队拔河',
          desc: '经典的团队力量对抗游戏',
          people: '12-30人',
          props: ['拔河绳', '标记线'],
          rules: [
            '分成两组，每组人数相等',
            '在标记线两侧进行拔河比赛',
            '将对方拉过标记线的一方获胜',
            '可以设置多轮比赛，增加竞争性',
            '注意安全，确保场地平整'
          ]
        },
        {
          name: '户外摄影大赛',
          desc: '比拼谁的户外照片最有创意',
          people: '4-20人',
          props: ['手机或相机', '主题卡片'],
          rules: [
            '设置摄影主题，如"最美风景""最有趣瞬间"等',
            '在规定时间内拍摄符合主题的照片',
            '统一展示，大家投票评选',
            '最佳照片获得奖品'
          ]
        }
      ]
    }
  },

  // 弹窗定时器变量（用于防止重复创建定时器）
  welcomeModalTimer: null,

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad(options) {
    console.log('页面加载')
    this._createRewardedVideoAd()
    this._checkUserData()
  },

  /**
   * 检查用户数据，显示欢迎信息或使用统计
   */
  _checkUserData() {
    // 防止重复弹出弹窗
    if (this.data.isShowingWelcomeModal || this.welcomeModalTimer !== null) {
      return
    }
    
    try {
      // 读取本地存储的用户数据
      const userData = wx.getStorageSync('userData')
      const now = new Date()
      const nowTime = now.getTime()
      
      if (!userData) {
        // 首次使用，创建用户数据
        const firstUseData = {
          firstUseTime: nowTime,
          lastUseTime: nowTime,
          useCount: 1
        }
        wx.setStorageSync('userData', firstUseData)
        
        // 设置标志，防止重复弹出
        this.setData({
          isShowingWelcomeModal: true
        })
        
        // 显示首次欢迎提示（使用定时器变量防止重复创建）
        this.welcomeModalTimer = setTimeout(() => {
          this.welcomeModalTimer = null
          wx.showModal({
            title: '🎉 欢迎使用互动点子库！',
            content: '感谢您的使用！这里有丰富的聚会小游戏，为您的聚会增添欢乐。\n\n快来选择一个场景，开始生成游戏吧！',
            showCancel: false,
            confirmText: '开始使用',
            confirmColor: '#D32F2F',
            success: () => {
              // 弹窗关闭后重置标志
              this.setData({
                isShowingWelcomeModal: false
              })
            },
            fail: () => {
              // 弹窗失败后重置标志
              this.setData({
                isShowingWelcomeModal: false
              })
            }
          })
        }, 500)
      } else {
        // 非首次使用，更新数据
        const updatedData = {
          firstUseTime: userData.firstUseTime || nowTime,
          lastUseTime: nowTime,
          useCount: (userData.useCount || 0) + 1
        }
        wx.setStorageSync('userData', updatedData)
        
        // 格式化上次使用时间
        const lastTime = new Date(userData.lastUseTime || nowTime)
        const timeDiff = nowTime - lastTime.getTime()
        let timeText = ''
        
        if (timeDiff < 60000) {
          timeText = '刚刚'
        } else if (timeDiff < 3600000) {
          const minutes = Math.floor(timeDiff / 60000)
          timeText = `${minutes}分钟前`
        } else if (timeDiff < 86400000) {
          const hours = Math.floor(timeDiff / 3600000)
          timeText = `${hours}小时前`
        } else if (timeDiff < 604800000) {
          const days = Math.floor(timeDiff / 86400000)
          timeText = `${days}天前`
        } else {
          const month = lastTime.getMonth() + 1
          const date = lastTime.getDate()
          timeText = `${month}月${date}日`
        }
        
        // 设置标志，防止重复弹出
        this.setData({
          isShowingWelcomeModal: true
        })
        
        // 显示欢迎回来信息（使用定时器变量防止重复创建）
        this.welcomeModalTimer = setTimeout(() => {
          this.welcomeModalTimer = null
          wx.showModal({
            title: '👋 欢迎回来！',
            content: `您上次使用：${timeText}\n累计使用：${updatedData.useCount}次\n\n感谢您的持续使用！如果觉得好用，欢迎分享给朋友们哦～`,
            showCancel: false,
            confirmText: '知道了',
            confirmColor: '#D32F2F',
            success: () => {
              // 弹窗关闭后重置标志
              this.setData({
                isShowingWelcomeModal: false
              })
            },
            fail: () => {
              // 弹窗失败后重置标志
              this.setData({
                isShowingWelcomeModal: false
              })
            }
          })
        }, 500)
      }
    } catch (e) {
      console.error('检查用户数据失败', e)
      // 出错时也重置标志和定时器
      if (this.welcomeModalTimer !== null) {
        clearTimeout(this.welcomeModalTimer)
        this.welcomeModalTimer = null
      }
      this.setData({
        isShowingWelcomeModal: false
      })
    }
  },

  /**
   * 创建激励视频广告实例，用于「换游戏」前观看广告
   */
  _createRewardedVideoAd() {
    if (!wx.createRewardedVideoAd) {
      console.warn('当前基础库不支持激励视频广告')
      return
    }
    try {
      this.videoAd = wx.createRewardedVideoAd({ adUnitId: REWARDED_VIDEO_AD_UNIT_ID })
      this.videoAd.onError(err => {
        console.error('激励视频广告错误', err)
      })
      this.videoAd.load().catch(() => {})
    } catch (e) {
      console.error('创建激励视频广告失败', e)
    }
  },

  /**
   * 播放激励视频广告，观看完整后执行 callback，否则提示「请观看完整广告」
   * 如果广告开关关闭（AD_ENABLED = false），直接执行 callback，不播放广告
   * @param {Function} callback 看完广告后要执行的操作（如随机生成、换一个、选择指定游戏）
   */
  showAdThenRun(callback) {
    // 如果广告开关关闭，直接执行操作，不播放广告
    if (!AD_ENABLED) {
      typeof callback === 'function' && callback()
      return
    }
    
    if (!this.videoAd) {
      wx.showToast({ title: '广告加载失败，请稍后重试', icon: 'none', duration: 2000 })
      return
    }
    const that = this
    const onClose = (res) => {
      that.videoAd.offClose(onClose)
      if (res && res.isEnded) {
        that.videoAd.load().catch(() => {})
        typeof callback === 'function' && callback()
      } else {
        wx.showToast({ title: '请观看完整广告后再试', icon: 'none', duration: 2000 })
      }
    }
    this.videoAd.onClose(onClose)
    this.videoAd.show().catch(() => {
      that.videoAd.offClose(onClose)
      wx.showToast({ title: '广告加载失败，请稍后重试', icon: 'none', duration: 2000 })
    })
  },

  /**
   * 场景选择处理函数
   * 点击"过年"或"结婚"按钮时触发
   */
  selectScene(e) {
    const scene = e.currentTarget.dataset.scene
    // 如果选择的是当前场景，则取消选择；否则设置为选中
    const newScene = this.data.selectedScene === scene ? null : scene
    
    this.setData({
      selectedScene: newScene,
      // 切换场景时，清空当前游戏
      currentGame: null
    })
    
    console.log('选择场景：', newScene)
    
    // 如果选择了场景，滚动到生成模式区
    if (newScene) {
      this._scrollToGenerateSection()
    }
  },

  /**
   * 滚动到生成模式区域
   */
  _scrollToGenerateSection() {
    // 延迟一下，确保页面渲染完成
    setTimeout(() => {
      const query = wx.createSelectorQuery().in(this)
      query.select('#generate-section').boundingClientRect()
      query.selectViewport().scrollOffset()
      query.exec((res) => {
        if (res && res[0] && res[1]) {
          // 计算目标滚动位置：当前滚动位置 + 元素距离视口顶部的距离 - 偏移量
          const scrollTop = res[1].scrollTop + res[0].top - 30
          wx.pageScrollTo({
            scrollTop: scrollTop,
            duration: 500
          }).catch((err) => {
            console.error('滚动失败：', err)
          })
        } else {
          // 如果找不到元素，延迟重试一次
          setTimeout(() => {
            const retryQuery = wx.createSelectorQuery().in(this)
            retryQuery.select('#generate-section').boundingClientRect()
            retryQuery.selectViewport().scrollOffset()
            retryQuery.exec((retryRes) => {
              if (retryRes && retryRes[0] && retryRes[1]) {
                const scrollTop = retryRes[1].scrollTop + retryRes[0].top - 30
                wx.pageScrollTo({
                  scrollTop: scrollTop,
                  duration: 500
                })
              }
            })
          }, 200)
        }
      })
    }, 100)
  },

  /**
   * 滚动到游戏详情区域
   */
  _scrollToGameDetail() {
    // 延迟一下，确保页面渲染完成
    setTimeout(() => {
      const query = wx.createSelectorQuery().in(this)
      query.select('#game-detail').boundingClientRect()
      query.selectViewport().scrollOffset()
      query.exec((res) => {
        console.log('滚动查询结果：', res)
        if (res && res[0] && res[1]) {
          // 计算目标滚动位置：当前滚动位置 + 元素距离视口顶部的距离 - 偏移量
          const scrollTop = res[1].scrollTop + res[0].top - 30
          console.log('准备滚动到：', scrollTop)
          wx.pageScrollTo({
            scrollTop: scrollTop,
            duration: 500
          }).then(() => {
            console.log('滚动成功')
          }).catch((err) => {
            console.error('滚动失败：', err)
            // 如果失败，尝试使用更简单的方式
            wx.pageScrollTo({
              scrollTop: scrollTop,
              duration: 500
            })
          })
        } else {
          console.warn('未找到游戏详情区域，延迟重试')
          // 如果第一次没找到，再延迟一点重试
          setTimeout(() => {
            const retryQuery = wx.createSelectorQuery().in(this)
            retryQuery.select('#game-detail').boundingClientRect()
            retryQuery.selectViewport().scrollOffset()
            retryQuery.exec((retryRes) => {
              if (retryRes && retryRes[0] && retryRes[1]) {
                const retryScrollTop = retryRes[1].scrollTop + retryRes[0].top - 30
                wx.pageScrollTo({
                  scrollTop: retryScrollTop,
                  duration: 500
                })
              }
            })
          }, 200)
        }
      })
    }, 300) // 增加延迟时间，确保页面完全渲染
  },

  /**
   * 随机生成游戏（内部逻辑，不包含广告）
   */
  _applyRandomGame() {
    const games = this.data.sceneGames[this.data.selectedScene]
    const randomIndex = Math.floor(Math.random() * games.length)
    const selectedGame = games[randomIndex]
    this.setData({ currentGame: selectedGame }, () => {
      // setData 完成后滚动到详情区域
      this._scrollToGameDetail()
    })
    console.log('随机生成游戏：', selectedGame.name)
  },

  /**
   * 随机生成游戏：先看激励视频广告，看完后随机选一款游戏
   */
  randomGenerate() {
    if (!this.data.selectedScene) {
      wx.showToast({ title: '请先选择场景', icon: 'none', duration: 2000 })
      return
    }
    this.showAdThenRun(() => this._applyRandomGame())
  },

  /**
   * 指定游戏生成：点击游戏名称时先看激励视频广告，看完后展示该游戏
   */
  selectGame(e) {
    const gameName = e.currentTarget.dataset.name
    if (!this.data.selectedScene) {
      wx.showToast({ title: '请先选择场景', icon: 'none', duration: 2000 })
      return
    }
    const games = this.data.sceneGames[this.data.selectedScene]
    const selectedGame = games.find(game => game.name === gameName)
    if (!selectedGame) return
    this.showAdThenRun(() => {
      this.setData({ currentGame: selectedGame }, () => {
        // setData 完成后滚动到详情区域
        this._scrollToGameDetail()
      })
      console.log('选择游戏：', selectedGame.name)
    })
  },

  /**
   * 换一个游戏：先看激励视频广告，看完后在同一场景下重新随机生成
   */
  changeGame() {
    if (!this.data.selectedScene) return
    this.showAdThenRun(() => this._applyRandomGame())
  },

  /**
   * 切换24点算术显示/隐藏
   */
  toggleGame24() {
    const showGame24 = !this.data.showGame24
    this.setData({ showGame24 })
    if (showGame24) {
      this.newGame24()
    } else {
      this.setData({
        game24Expression: '',
        game24Message: '',
        game24MessageType: ''
      })
    }
  },

  /**
   * 生成新的24点算术（从预设组合中随机选择，确保不重复）
   */
  newGame24() {
    // 获取已使用的组合索引（从本地存储）
    let usedIndices = wx.getStorageSync('game24_used_indices') || []
    
    // 如果所有组合都用完了，重置记录
    if (usedIndices.length >= GAME24_COMBINATIONS.length) {
      usedIndices = []
      wx.setStorageSync('game24_used_indices', [])
    }
    
    // 获取未使用的组合索引
    const availableIndices = []
    for (let i = 0; i < GAME24_COMBINATIONS.length; i++) {
      if (usedIndices.indexOf(i) === -1) {
        availableIndices.push(i)
      }
    }
    
    // 从未使用的组合中随机选择一个
    const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)]
    const numbers = [...GAME24_COMBINATIONS[randomIndex]]
    
    // 记录已使用的索引
    usedIndices.push(randomIndex)
    wx.setStorageSync('game24_used_indices', usedIndices)
    
    this.setData({
      game24Numbers: numbers,
      game24Expression: '',
      game24Message: '',
      game24MessageType: '',
      game24Answer: ''
    })

    // 立即在后台计算答案（不显示加载提示）
    setTimeout(() => {
      try {
        const answer = this._solve24(numbers)
        if (answer) {
          this.setData({
            game24Answer: answer
          })
          console.log('24点答案计算成功:', numbers, '->', answer)
        } else {
          console.error('24点答案计算失败:', numbers)
          // 如果找不到答案，可能是算法问题，需要优化
        }
      } catch (e) {
        console.error('24点答案计算异常:', numbers, e)
      }
    }, 50)
  },

  /**
   * 显示24点算术答案
   */
  showGame24Answer() {
    const numbers = this.data.game24Numbers
    if (numbers.length !== 4) {
      wx.showToast({
        title: '请先生成题目',
        icon: 'none'
      })
      return
    }

    // 如果已经有答案，直接显示
    if (this.data.game24Answer) {
      this.setData({
        game24Message: `💡 答案：${this.data.game24Answer}\n（24 点的解法可不止这一种哦，这只是其中一个思路，快试试能不能想出更多创意解法吧～）`,
        game24MessageType: 'success'
      })
      return
    }

    // 计算答案
    wx.showLoading({
      title: '计算中...',
      mask: true
    })

    setTimeout(() => {
      const answer = this._solve24(numbers)
      if (answer) {
        this.setData({
          game24Answer: answer,
          game24Message: `💡 答案：${answer}\n（可能有多个答案，这里只给一个）`,
          game24MessageType: 'success'
        })
      } else {
        this.setData({
          game24Message: '❌ 这组数字无法计算出24，点击"换一组数字"试试',
          game24MessageType: 'error'
        })
      }
      wx.hideLoading()
    }, 100)
  },

  /**
   * 24点算术输入处理
   */
  onGame24Input(e) {
    this.setData({
      game24Expression: e.detail.value,
      game24Message: '',
      game24MessageType: ''
    })
  },

  /**
   * 24点算术虚拟键盘点击处理
   * 支持：数字、加减乘除、括号，以及删除 / 清空
   */
  insertGame24Symbol(e) {
    const value = e.currentTarget.dataset.value
    const action = e.currentTarget.dataset.action

    let expr = this.data.game24Expression || ''

    if (action === 'backspace') {
      // 删除最后一个字符
      expr = expr.slice(0, -1)
    } else if (action === 'clear') {
      // 清空输入
      expr = ''
    } else if (value) {
      // 追加一个符号
      expr += value
    }

    this.setData({
      game24Expression: expr,
      game24Message: '',
      game24MessageType: ''
    })
  },

  /**
   * 提交24点算术答案
   */
  submitGame24() {
    const expression = this.data.game24Expression.trim()
    const numbers = this.data.game24Numbers

    if (!expression) {
      this.setData({
        game24Message: '请输入算式',
        game24MessageType: 'error'
      })
      return
    }

    // 验证是否使用了所有4个数字
    const usedNumbers = this._extractNumbers(expression)
    if (!this._validateNumbers(usedNumbers, numbers)) {
      this.setData({
        game24Message: '❌ 必须使用全部4个数字，且每个数字只能使用一次',
        game24MessageType: 'error'
      })
      return
    }

    // 计算表达式结果
    try {
      const result = this._safeEval(expression)
      if (Math.abs(result - 24) < 0.0001) {
        this.setData({
          game24Message: '🎉 恭喜！答案正确！点击"换一组数字"继续挑战',
          game24MessageType: 'success'
        })
        // 不再自动生成新题目，让用户手动点击"换一组数字"
      } else {
        this.setData({
          game24Message: `❌ 计算结果为 ${result}，不等于24，请再试试`,
          game24MessageType: 'error'
        })
      }
    } catch (e) {
      this.setData({
        game24Message: '❌ 算式格式错误，请检查',
        game24MessageType: 'error'
      })
    }
  },

  /**
   * 从表达式中提取数字
   */
  _extractNumbers(expression) {
    // 移除所有运算符和括号，提取数字
    const numbers = []
    const regex = /\d+/g
    let match
    while ((match = regex.exec(expression)) !== null) {
      numbers.push(parseInt(match[0]))
    }
    return numbers
  },

  /**
   * 验证使用的数字是否与给定的4个数字匹配
   */
  _validateNumbers(usedNumbers, targetNumbers) {
    if (usedNumbers.length !== 4) {
      return false
    }
    const sortedUsed = [...usedNumbers].sort((a, b) => a - b)
    const sortedTarget = [...targetNumbers].sort((a, b) => a - b)
    for (let i = 0; i < 4; i++) {
      if (sortedUsed[i] !== sortedTarget[i]) {
        return false
      }
    }
    return true
  },

  /**
   * 求解24点问题
   */
  _solve24(numbers) {
    if (numbers.length !== 4) {
      console.error('_solve24: 数字数量不正确', numbers)
      return null
    }
    
    try {
      // 尝试所有可能的运算组合
      const ops = ['+', '-', '*', '/']
      const nums = numbers.map(n => Number(n)) // 确保是数字类型
      
      // 生成所有可能的数字排列
      const permutations = this._permute(nums)
      if (!permutations || permutations.length === 0) {
        console.error('_solve24: 排列生成失败', numbers)
        return null
      }
      
      // 尝试所有排列和运算符组合
      let totalAttempts = 0
      let errorCount = 0
      for (const perm of permutations) {
        for (const op1 of ops) {
          for (const op2 of ops) {
            for (const op3 of ops) {
              // 尝试不同的括号组合（增加更多组合以确保覆盖所有情况）
              const expressions = [
                `(${perm[0]}${op1}${perm[1]})${op2}(${perm[2]}${op3}${perm[3]})`,
                `((${perm[0]}${op1}${perm[1]})${op2}${perm[2]})${op3}${perm[3]}`,
                `(${perm[0]}${op1}(${perm[1]}${op2}${perm[2]}))${op3}${perm[3]}`,
                `${perm[0]}${op1}((${perm[1]}${op2}${perm[2]})${op3}${perm[3]})`,
                `${perm[0]}${op1}(${perm[1]}${op2}(${perm[2]}${op3}${perm[3]}))`,
                `(${perm[0]}${op1}${perm[1]})${op2}${perm[2]}${op3}${perm[3]}`,
                `${perm[0]}${op1}(${perm[1]}${op2}${perm[2]})${op3}${perm[3]}`,
                `${perm[0]}${op1}${perm[1]}${op2}(${perm[2]}${op3}${perm[3]})`,
                `(${perm[0]}${op1}${perm[1]}${op2}${perm[2]})${op3}${perm[3]}`,
                `${perm[0]}${op1}${perm[1]}${op2}${perm[2]}${op3}${perm[3]}`
              ]
              
              for (const expr of expressions) {
                totalAttempts++
                try {
                  const result = this._safeEval(expr)
                  // 检查结果是否有效（与 _safeEval 中的检查保持一致）
                  if (result !== null && result !== undefined && !isNaN(result) && isFinite(result)) {
                    const diff = Math.abs(result - 24)
                    if (diff < 0.0001) {
                      // 转换为中文运算符显示
                      const answer = expr
                        .replace(/\*/g, '×')
                        .replace(/\//g, '÷')
                      console.log('_solve24: 找到答案', numbers, '->', answer, '结果:', result, '尝试次数:', totalAttempts)
                      return answer
                    }
                  }
                } catch (e) {
                  errorCount++
                  // 忽略计算错误，继续尝试
                  // 只在调试时输出错误（避免控制台刷屏）
                  // console.log('_solve24: 表达式计算失败', expr, e.message)
                }
              }
            }
          }
        }
      }
      
      console.error('_solve24: 未找到答案', numbers, '总尝试次数:', totalAttempts, '错误次数:', errorCount)
      return null
    } catch (e) {
      console.error('_solve24: 异常', numbers, e)
      return null
    }
  },

  /**
   * 生成数组的所有排列
   */
  _permute(arr) {
    if (arr.length <= 1) return [arr]
    const result = []
    for (let i = 0; i < arr.length; i++) {
      const rest = [...arr.slice(0, i), ...arr.slice(i + 1)]
      const perms = this._permute(rest)
      for (const perm of perms) {
        result.push([arr[i], ...perm])
      }
    }
    return result
  },

  /**
   * 安全计算表达式（不依赖 eval 和 new Function，使用栈计算）
   */
  _safeEval(expression) {
    try {
      // 替换中文运算符为英文
      let expr = expression
        .replace(/×/g, '*')
        .replace(/÷/g, '/')
        .replace(/（/g, '(')
        .replace(/）/g, ')')
        .replace(/\s+/g, '')
      
      // 验证表达式只包含数字、运算符和括号
      if (!/^[\d\+\-\*\/\(\)\.\s]+$/.test(expr)) {
        throw new Error('Invalid expression: ' + expr)
      }

      // 使用栈计算表达式（不依赖 eval 和 new Function）
      return this._calculateExpression(expr)
    } catch (e) {
      throw e
    }
  },

  /**
   * 使用栈计算表达式（支持 +、-、*、/ 和括号）
   */
  _calculateExpression(expr) {
    // 处理负数：将 (- 替换为 (0-
    expr = expr.replace(/\(-/g, '(0-')
    // 处理开头的负数
    if (expr.startsWith('-')) {
      expr = '0' + expr
    }

    // 使用两个栈：一个存数字，一个存运算符
    const numStack = []
    const opStack = []
    
    let i = 0
    while (i < expr.length) {
      const char = expr[i]
      
      // 跳过空格
      if (char === ' ') {
        i++
        continue
      }
      
      // 如果是数字，读取完整的数字
      if (this._isDigit(char)) {
        let num = ''
        while (i < expr.length && (this._isDigit(expr[i]) || expr[i] === '.')) {
          num += expr[i]
          i++
        }
        numStack.push(parseFloat(num))
        continue
      }
      
      // 如果是左括号，入栈
      if (char === '(') {
        opStack.push(char)
        i++
        continue
      }
      
      // 如果是右括号，计算到左括号
      if (char === ')') {
        while (opStack.length > 0 && opStack[opStack.length - 1] !== '(') {
          this._applyOperator(numStack, opStack)
        }
        opStack.pop() // 移除左括号
        i++
        continue
      }
      
      // 如果是运算符
      if (this._isOperator(char)) {
        // 处理运算符优先级
        while (opStack.length > 0 && 
               opStack[opStack.length - 1] !== '(' &&
               this._getPrecedence(opStack[opStack.length - 1]) >= this._getPrecedence(char)) {
          this._applyOperator(numStack, opStack)
        }
        opStack.push(char)
        i++
        continue
      }
      
      i++
    }
    
    // 处理剩余的运算符
    while (opStack.length > 0) {
      this._applyOperator(numStack, opStack)
    }
    
    if (numStack.length !== 1) {
      throw new Error('Invalid expression')
    }
    
    const result = numStack[0]
    if (result === null || result === undefined || isNaN(result) || !isFinite(result)) {
      throw new Error('Invalid result: ' + result)
    }
    
    return result
  },

  /**
   * 判断是否是数字
   */
  _isDigit(char) {
    return char >= '0' && char <= '9'
  },

  /**
   * 判断是否是运算符
   */
  _isOperator(char) {
    return char === '+' || char === '-' || char === '*' || char === '/'
  },

  /**
   * 获取运算符优先级
   */
  _getPrecedence(op) {
    if (op === '+' || op === '-') {
      return 1
    }
    if (op === '*' || op === '/') {
      return 2
    }
    return 0
  },

  /**
   * 应用运算符
   */
  _applyOperator(numStack, opStack) {
    if (numStack.length < 2 || opStack.length < 1) {
      throw new Error('Invalid expression')
    }
    
    const b = numStack.pop()
    const a = numStack.pop()
    const op = opStack.pop()
    
    let result
    switch (op) {
      case '+':
        result = a + b
        break
      case '-':
        result = a - b
        break
      case '*':
        result = a * b
        break
      case '/':
        if (b === 0) {
          throw new Error('Division by zero')
        }
        result = a / b
        break
      default:
        throw new Error('Unknown operator: ' + op)
    }
    
    numStack.push(result)
  }

})
